# Day 10 - 暫存狀態 vs 程式狀態

id: 10
tag: 設計

當我們使用狀態管理之後，可能會思考，是否再也不需要使用 StatefulWidget 了？今天我們就來談談這個問題。首先，我們先看一個例子，假設今天畫設計師設計了一個按鈕，當按鈕被壓著時，按鈕需要變個顏色，讓使用者感知自己有按到按鈕

![it_img_10_1.jpg](Day%2010%20-%20%E6%9A%AB%E5%AD%98%E7%8B%80%E6%85%8B%20vs%20%E7%A8%8B%E5%BC%8F%E7%8B%80%E6%85%8B/it_img_10_1.jpg)

![截圖 2022-09-23 下午11.15.23.png](Day%2010%20-%20%E6%9A%AB%E5%AD%98%E7%8B%80%E6%85%8B%20vs%20%E7%A8%8B%E5%BC%8F%E7%8B%80%E6%85%8B/%25E6%2588%25AA%25E5%259C%2596_2022-09-23_%25E4%25B8%258B%25E5%258D%258811.15.23.png)

[https://dartpad.dev/?id=1ce393e000000b9df586a11d7c6ae495](https://dartpad.dev/?id=1ce393e000000b9df586a11d7c6ae495)

在上面的例子中，我們使用狀態管理來實現這個設計，可以發現在 ButtonStatus 中，我們維護了一個按鈕是否被按下的布林值，並且宣告了一個相對應的 Provider。雖然我們可以用狀態管理套件，完成這個功能，但實際上，會發現其實 ButtonStatus 並沒有多大的意義，形成一個壞味道：[Lazy Class](https://refactoring.guru/smells/lazy-class)。

## 把職責合併回 StatefulWidget

我們來看看使用 StatefulWidget 實現會變得如何？

![it_img_10_3.png](Day%2010%20-%20%E6%9A%AB%E5%AD%98%E7%8B%80%E6%85%8B%20vs%20%E7%A8%8B%E5%BC%8F%E7%8B%80%E6%85%8B/it_img_10_3.png)

[https://dartpad.dev/?id=4c56071a63fa7416c4c22578694fa1e0](https://dartpad.dev/?id=4c56071a63fa7416c4c22578694fa1e0)

可以發現在這個場景中，使用 StatefulWidget 實現的話，我們只要在 State 維護一個布林值，並利用 setState 更新按鈕狀態與重 build 畫面。

## 暫存狀態 vs 程式狀態

客端程式中，大多時候都要維護各式各樣的狀態，我們可以把狀態分為兩種：暫存狀態和程式狀態。在按鈕的例子中，isPressed 的布林值就比較屬於暫存狀態，當 Button 消失時，這 isPressed 也隨之消失。在昨天顯示 User 的例子中，即便畫面關閉了，User 這個狀態還是需要存在程式中，以便其他畫面使用。

## 暫存狀態一定使用 StatefulWidget？

那是否暫存狀態就得永遠使用 StatefulWidget 呢？那倒也不是，管理狀態的邏輯比較複雜時，我們適當的使用狀態管理套件，將邏輯與畫面分開，能夠將一個比較複雜的類別，簡化成兩個比較簡單的類別，是具有意義的。在前天的選擇照片的例子中，選擇的照片在離開了選擇照片頁面之後，可能也不存在意義了。但是我們還是使用了狀態管理來改善，也是基於上述理由。

反之亦然，是否所有程式狀態也並非一定要使用狀態管理。在按鈕的例子中，假設需求變得複雜了，我們需要一個時間倒數的按鈕，並且擁有倒數/暫停等較複雜的行為時，使用狀態管理還是有一定好處。

![it_img_10_4.png](Day%2010%20-%20%E6%9A%AB%E5%AD%98%E7%8B%80%E6%85%8B%20vs%20%E7%A8%8B%E5%BC%8F%E7%8B%80%E6%85%8B/it_img_10_4.png)

[https://dartpad.dev/?id=c93d29f9a38a0482a15ba028155d681e](https://dartpad.dev/?id=c93d29f9a38a0482a15ba028155d681e)

## 結論

如何選擇使用 StatefulWidget 或者狀態管理套件，可以先判斷情境屬於暫存狀態或者程式狀態，並決定使用哪種實現，當實現一版之後，發現暫存狀態的邏輯過於複雜，還是可以改用狀態管理套件。

## 參考

- Lazy Class：[https://refactoring.guru/smells/lazy-class](https://refactoring.guru/smells/lazy-class)
- Differentiate between ephemeral state and app state：[https://docs.flutter.dev/development/data-and-backend/state-mgmt/ephemeral-vs-app](https://docs.flutter.dev/development/data-and-backend/state-mgmt/ephemeral-vs-app)

## 再也不需要 StatefulWidget?

當我們熟悉使用狀態管理套件之後，或許會感覺自己再也不需要寫 StatefulWidget 了。我自己的觀點是：如果 Widget 本身的邏輯並不複雜，也沒有共用的需求，應該是以使用 StatefulWidget 為優先選擇。假設今天設計師製作一個 Button 按下時需要變換顏色的設計，此時如果還是使用狀態管理套件來維護按鈕狀態，像下面這段程式碼一樣，就有點大材小用了。

既然狀態管理套件這麼好用，那是否再也不需要 stateful widget

有時候我們會開發一個比較複雜的畫面 例如按鈕的 press Hoover 要不同顏色

或許有人會問 有了狀態管理套件 是否再也不需要 stateful widget

並非如此 有些狀態與widget 緊緊相依 讓他們在 ui 裡面有助於理解 也讓狀態管理比較好測試

違反 feature envy

若是擔心 setState 作用範圍太大 應該是要使用抽取 widget 抽到合適大小

## 參考

- Differentiate between ephemeral state and app state：[https://docs.flutter.dev/development/data-and-backend/state-mgmt/ephemeral-vs-app](https://docs.flutter.dev/development/data-and-backend/state-mgmt/ephemeral-vs-app)