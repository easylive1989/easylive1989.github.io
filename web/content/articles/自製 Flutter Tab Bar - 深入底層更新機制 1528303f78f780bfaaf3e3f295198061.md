# è‡ªè£½ Flutter Tab Bar - æ·±å…¥åº•å±¤æ›´æ–°æ©Ÿåˆ¶

æ–°å¢æ™‚é–“: December 4, 2024 10:24 PM
æœ€å¾Œç·¨è¼¯æ™‚é–“: October 24, 2025 5:17 PM
AI summary: æœ¬æ–‡æ¢è¨äº† Element æ›´æ–°æ©Ÿåˆ¶ï¼Œä¸¦åˆ†æ Row + Expanded èˆ‡ AnimatedSize ç„¡æ³•æ­£å¸¸é‹ä½œçš„å…ƒå› ã€‚æœ€å¾Œæä¾›äº†å…©ç¨®è§£æ±ºæ–¹æ¡ˆï¼šä½¿ç”¨ Expanded ä¸¦å°‡ flex è¨­ç‚º 0ï¼Œæˆ–ä½¿ç”¨ GlobalObjectKeyã€‚
id: 1528303f78f780bfaaf3e3f295198061
é¡å‹: è¼¸å‡ºæ–‡ç« 
ğŸ§© é ˜åŸŸ: Flutter (https://www.notion.so/Flutter-aec5ea3a198f49e18989ab7f4c851169?pvs=21)

![image.png](%E8%87%AA%E8%A3%BD%20Flutter%20Tab%20Bar%20-%20%E6%B7%B1%E5%85%A5%E5%BA%95%E5%B1%A4%E6%9B%B4%E6%96%B0%E6%A9%9F%E5%88%B6/image.png)

é€™å€‹ç³»åˆ—çµ‚æ–¼è¿ä¾†æœ€çµ‚å›äº†ï¼Œç‚ºäº†å®Œæˆä¸‹åœ–é€™å€‹ç‰¹åˆ¥çš„ Tab Bar å‹•ç•«æ•ˆæœï¼Œæˆ‘å€‘æœ€åˆç›´æ¥ä½¿ç”¨ CustomMultiChildLayout ä¾†å®Œæˆï¼Œä½†æ˜¯ä¹ŸåŒæ™‚å¥½å¥‡ç‚ºä»€éº¼ Row + Expanded + AnimatedSize åšä¸åˆ°ä¸€æ¨£æ•ˆæœï¼Œæ‰€ä»¥åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­åˆ†æäº† Row çš„ä½ˆå±€é‚è¼¯ã€‚

![image.png](%E8%87%AA%E8%A3%BD%20Flutter%20Tab%20Bar%20-%20%E6%B7%B1%E5%85%A5%E5%BA%95%E5%B1%A4%E6%9B%B4%E6%96%B0%E6%A9%9F%E5%88%B6/image%201.png)

ä½†æ˜¯åœ¨ç ”ç©¶ Row çš„éç¨‹ä¸­ï¼Œå»ç™¼ç¾äº‹æƒ…è·Ÿæƒ³åƒä¸­çš„ä¸åŒã€‚ä»¥ Row çš„ä½ˆå±€é‚è¼¯ä¾†èªªï¼Œæ‡‰è©²è¦èƒ½å®Œç¾çš„é…åˆ AnimatedSize çš„å‹•ç•«ï¼Œè®“ AnimatedSize ä¸­å­ Widget åœ¨å¤§å°æœ‰æ‰€è®ŠåŒ–æ™‚ï¼Œå¯ä»¥é †æš¢åœ°ä»¥å‹•ç•«çš„æ–¹å¼å‘ˆç¾ã€‚

ä½†æ˜¯ç•¶å¯¦éš›ä½¿ç”¨äº† Row + Expanded åŒ…åœ¨ AnimatedSize å¤–é¢æ™‚ï¼Œæ•ˆæœä¸¦ä¸å¦‚é æœŸã€‚ç•¶ç‹€æ…‹æ”¹è®Šæ™‚ï¼ŒAnimatedSize ä¸­çš„ Tab å»æ˜¯ä¸€ç¬é–“ç¸®å°ï¼Œè€Œä¸æ˜¯ä»¥å‹•ç•«å½¢å¼è®Šå°ã€‚

![image.png](%E8%87%AA%E8%A3%BD%20Flutter%20Tab%20Bar%20-%20%E6%B7%B1%E5%85%A5%E5%BA%95%E5%B1%A4%E6%9B%B4%E6%96%B0%E6%A9%9F%E5%88%B6/image%202.png)

```dart
Row(
  children: [
    for (int index = 0; index < tabLength; index++)
      currentIndex == index
          ? AnimatedSize(
            duration: const Duration(milliseconds: 300),
            child: _SelectedTab(index: index),
          )
          : Expanded(
              child: AnimatedSize(
                duration: const Duration(milliseconds: 300),
                child: GestureDetector(
                  onTap: () => setState(() => currentIndex = index),
                  child: _UnselectedTab(index: index),
                ),
              ),
            )
  ],
)
```

é‚£é€™æ˜¯ç‚ºä»€éº¼å‘¢ï¼Ÿæ˜æ˜ Row æ²’æœ‰é™åˆ¶å­ Widget å¤§å°ï¼Œç‚ºä»€éº¼é¸ä¸­çš„ Tab æ²’æœ‰æŒ‰ç…§é æœŸçš„ç”¨å‹•ç•«è®Šå¤§è®Šå°å‘¢ï¼Ÿ

ç­”æ¡ˆå…¶å¯¦æ˜¯ï¼š**å› ç‚ºè¢«é¸ä¸­çš„ Tab æ²’è¢« Expanded åŒ…ä½**ã€‚

å° Flutter ä¸ç†Ÿæ‚‰çš„è§€çœ¾å¯èƒ½æœƒæ»¿é ­å•è™Ÿï¼Œç‚ºä»€éº¼æ²’æœ‰è¢« Expanded åŒ…ä½æœƒé€ æˆå•é¡Œï¼Ÿè€Œä¸”å¦‚æœè¦ç”¨ Expanded åŒ…ä½è¢«é¸ä¸­çš„ Tabï¼Œæˆ‘å€‘åˆè¦å¦‚ä½•ä¸é™åˆ¶é¸ä¸­çš„ Tab å¤§å°ï¼Ÿ

è®“æˆ‘å€‘ä¾†ä¸€ä¸€è§£ç­”é€™äº›å•é¡Œå§ã€‚

## Element Tree çš„æ›´æ–°é‚è¼¯

é¦–å…ˆï¼Œå° Flutter æœ‰ç ”ç©¶çš„è§€çœ¾å¤šå°‘éƒ½æœƒçŸ¥é“ï¼ŒFlutter æ¡†æ¶åº•å±¤ç¶­è­·äº†ä¸‰é¡†æ¨¹ï¼šWidget Treeã€Element Tree èˆ‡ RenderObject Treeï¼Œä»–å€‘åˆ†åˆ¥æŒç®¡äº†ä¸åŒè·è²¬ã€‚

å…¶ä¸­ Element è² è²¬ç®¡ç† Widget èˆ‡ RenderObjectï¼Œç•¶ç‹€æ…‹æ”¹è®Šæ™‚ï¼Œèƒ½æœ‰æ•ˆçš„å› æ‡‰è®ŠåŒ–ï¼Œåªèª¿æ•´æœ‰æ”¹è®Šçš„éƒ¨åˆ†ï¼Œé¿å…é »ç¹çš„é‡å»º Elementï¼Œé€²è€Œæé«˜æ•ˆèƒ½ã€‚

ç•¶ç•«é¢éœ€è¦æ›´æ–°æ™‚ï¼ŒElement æœƒå¾éœ€è¦æ›´æ–°çš„ Element é–‹å§‹ï¼Œä¸€è·¯å¾€å­ Element æ›´æ–°ã€‚

ç•¶æ›´æ–°æŸå€‹ Element æ™‚ï¼ŒElement ä¸­çš„ `updateChild` æ–¹æ³•å°±æœƒè¢«å‘¼å«ï¼Œç”¨ä¾†è™•ç†ç•¶å‰ Element çš„ä¸‹ä¸€å±¤ç¯€é»çµæ§‹è®ŠåŒ–ã€‚åœ¨ `updateChild` æ–¹æ³•çš„ä¸Šæ–¹ä¹Ÿæœ‰ä¸€å¤§æ®µè¨»é‡‹åœ¨è§£é‡‹å…¶é‹ä½œé‚è¼¯ï¼Œå…¶ä¸­åŒ…å«äº†ä¸€æ®µè¡¨æ ¼ï¼Œç”¨ä¾†å±•ç¤ºå¹¾ç¨®æ›´æ–°çš„ç‹€æ³ã€‚

```markdown
|                 |   newWidget == null    |       newWidget != null          |
| :-------------: | :--------------------- | :------------------------------- |
|  child == null  |  Returns null.         |  Returns new [Element].          |
|                 |                        |                                  |
|  child != null  |  Old child is removed, | Old child updated if possible,   |
|                 |  returns null.         | returns child or new [Element].  |  
```

è¡¨æ ¼ä¸­çš„ child æ˜¯æŒ‡ç•¶å‰æ›´æ–°ä¸­çš„ Element çš„å­ç¯€é»ï¼Œè€Œ newWidget å‰‡æ˜¯æ‰“ç®—æ–°å¢é€²ä¾†çš„ Widgetã€‚è®“æˆ‘å€‘çœ‹å€‹ç°¡å–®çš„ä¾‹å­ï¼Œå‡è¨­æˆ‘å€‘åœ¨ç•«é¢ä¸­å­˜åœ¨è‘—ä¸€å€‹ Textï¼Œé€™å€‹ Text æœƒéš¨è‘—ä¸åŒçš„ç‹€æ…‹è€Œå‡ºç¾åº•è‰²ã€‚

```dart
class _MyTextState extends State<MyText> {
  bool isHighlight = false;

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: () => setState(() => isHighlight = !isHighlight),
      child: isHighlight
          ? Container(color: Colors.red, child: const Text("Hello World"))
          : const Text("Hello World"),
    );
  }
}

```

è‹¥ç•¶å‰ isHighlight ç‚º falseï¼Œç•«é¢ä¸­çš„ Text("Hello World") ä¹Ÿæ²’æœ‰ä»»ä½•åº•è‰²ã€‚æ¥è‘—ä¸‹ä¸€ç§’ç¨‹å¼å‘¼å«äº† setState ä¸¦å°‡ isHighlight æ›´æ–°ç‚º trueã€‚GestureDetector çš„å­ Widget ä¹Ÿå¾ Text æ”¹è®Šæˆ Containerã€‚

æ­¤æ™‚ GestureDetector çš„ Element çš„ updateChild æ–¹æ³•å°±æœƒè¢«å‘¼å«åˆ°ï¼Œå¸¶é€²ä¾†çš„ child å°±æ˜¯ Textï¼Œè€Œ newWidget å‰‡æ˜¯ Containerã€‚ï¼ˆè¨»ï¼šäº‹å¯¦ä¸Šï¼ŒGestureDetector ä¸¦é Text çš„çˆ¶æ¯ï¼Œè€Œæ˜¯ç¥–çˆ¶æ¯ï¼Œå› ç‚º GestureDetector ä¸­é‚„åŒ…äº†è¨±å¤šå…¶ä»– Widgetï¼Œé€™è£¡ç‚ºäº†èªªæ˜æ–¹ä¾¿è€Œç°¡åŒ–ã€‚ï¼‰

```dart
Element? updateChild(Element? child, Widget? newWidget, Object? newSlot) {
    ...
}
```

æŒ‰ç…§ä¸Šé¢è¡¨æ ¼çš„é‚è¼¯ child ä¸ç‚º nullï¼ŒnewWidget ä¹Ÿä¸ç‚º nullï¼Œå°±æœƒèµ°åˆ° **Old child updated if possible, returns child or new [Element]** é€™æ®µåˆ†æ”¯ã€‚é€™æ®µé‚è¼¯åˆ†æ”¯ä¸»è¦ç”±ä¸‰å€‹ if åˆ¤æ–·å¯¦ç¾ï¼Œç¬¬ä¸€å€‹ if æœƒæ¯”è¼ƒ child.widget èˆ‡ newWidget æ˜¯å¦ç›¸åŒï¼Œé€™è£¡æ¯”è¼ƒçš„æ˜¯å…©è€…æ˜¯å¦æ˜¯ç›¸åŒå¯¦ä¾‹ã€‚é€šå¸¸å¦‚æœä½¿ç”¨ const çš„ Widget å°±æœƒç›´æ¥è½å…¥é€™å€‹ if æ¢ä»¶ä¸­ã€‚

```dart
if (hasSameSuperclass && child.widget == newWidget) {
  if (child.slot != newSlot) {
    updateSlotForChild(child, newSlot);
  }
  newChild = child;
}
```

è‹¥ä»¥ä¸Šé¢çš„ç¯„ä¾‹ä¾†èªªï¼Œchild.widget æ˜¯ Textï¼Œè€Œ newWidget å‰‡æ˜¯ Containerã€‚å…©è€…é¡åˆ¥éƒ½ä¸åŒäº†ï¼Œæ›´åˆ¥ææ˜¯å¦æ˜¯ç›¸åŒå¯¦ä¾‹äº†ã€‚ï¼ˆè¨»ï¼šä»¥ä¸‹ `updateChild` æ–¹æ³•é‚è¼¯ç¶“éç°¡åŒ–ï¼ŒåŸå§‹ç¢¼å¯ä»¥åƒè€ƒ[é€™é‚Š](https://github.com/flutter/flutter/blob/master/packages/flutter/lib/src/widgets/framework.dart)ã€‚ï¼‰

æ¥è‘—çœ‹åˆ°ä¸‹ä¸€æ®µ if åˆ¤æ–·ï¼Œåˆ¤æ–·æ˜¯å¦å¯ä»¥é€éæ›´æ–° Element ä¾†é¿å…å»ºç«‹æ–° Elementã€‚

```dart
if (hasSameSuperclass && child.widget == newWidget) {
  // çœç•¥...
} else if (hasSameSuperclass && Widget.canUpdate(child.widget, newWidget)) {
  if (child.slot != newSlot) {
    updateSlotForChild(child, newSlot);
  }
  child.update(newWidget);
  newChild = child;
}
```

åœ¨é€™å€‹ if åˆ¤æ–·ä¸­ï¼Œæœ€ä¸»è¦çš„åˆ¤æ–·ç”± `Widget.canUpdate` æ±ºå®šï¼Œä¾†çœ‹ä¸€ä¸‹ `Widget.canUpdate` çš„é‚è¼¯ã€‚

```dart
abstract class Widget extends DiagnosticableTree {
  static bool canUpdate(Widget oldWidget, Widget newWidget) {
    return oldWidget.runtimeType == newWidget.runtimeType
        && oldWidget.key == newWidget.key;
  }
}
```

å¸¶å…¥ä¸Šé¢çš„ç¯„ä¾‹å¾Œï¼Œæˆ‘å€‘æœƒç™¼ç¾ oldWidget (Text) çš„ runtimeType èˆ‡ newWidget (Container) çš„ runtimeType ä¸åŒäº†ï¼Œæ‰€ä»¥ä¹Ÿç„¡æ³•ç›´æ¥æ›´æ–° Elementã€‚

è‡³æ­¤ä¹Ÿåªæœ‰æœ€å¾Œä¸€æ¢è·¯å¯ä»¥èµ°ï¼Œä¹Ÿå°±æ˜¯å»ºç«‹æ–°çš„ Elementï¼Œé€™é‚Šå†å¾€ä¸‹èµ°å°±æœƒå…ˆåœç”¨ç•¶å‰çš„ Elementï¼Œæ¥è‘—åœ¨ inflateWidget æ–¹æ³•ä¸­å‘¼å« Widget èº«ä¸Šçš„ createElement æ–¹æ³•ä¾†å»ºç«‹æ–°çš„ Elementã€‚

```dart
if (hasSameSuperclass && child.widget == newWidget) {
  // çœç•¥...
} else if (hasSameSuperclass && Widget.canUpdate(child.widget, newWidget)) {
  // çœç•¥...
} else {
  deactivateChild(child);
  newChild = inflateWidget(newWidget, newSlot);
}
```

è‡³æ­¤æˆ‘å€‘æ‡‰è©²å¯ä»¥å›ç­”ï¼š**ç‚ºä»€éº¼è¢«é¸ä¸­çš„ Tab æ²’è¢« Expanded åŒ…ä½æœƒé€ æˆ AnimatedSize å¤±æ•ˆ**ï¼Œå…¶å¯¦åŸå› å°±æ˜¯å› ç‚º AnimatedSize é‡å»ºäº†ã€‚é‚£ AnimatedSize è¢«é‡å»ºç‚ºä»€éº¼æœƒé€ æˆå‹•ç•«å¤±æ•ˆå‘¢ï¼Ÿå…¶å¯¦åŸå› ä¹Ÿå¾ˆå¥½æƒ³åƒ AnimatedSize è‹¥æƒ³è¦æœ‰å‹•ç•«æ•ˆæœï¼Œä»–å°±å¿…é ˆæœ‰**æ”¹è®Šå‰çš„ç‹€æ…‹**èˆ‡**æ”¹è®Šå¾Œçš„ç‹€æ…‹**ï¼Œé€™æ¨£æ‰èƒ½å¤ çŸ¥é“è¦è®Šå¤§é‚„æ˜¯è®Šå°ã€‚

å‡è¨­ç•¶å‰ AnimatedSize çš„å¯¬åº¦ç‚º 10ï¼ŒsetState å¾Œè®Šæˆ 20ï¼ŒAnimatedSize å°±æœƒçŸ¥é“è¦å¾å¯¬åº¦è¦å¾ 10 æ…¢æ…¢è®ŠåŒ–æˆ 20ã€‚ä½†æ˜¯å¦‚æœæ˜¯é‡å»º AnimatedSize çš„æƒ…æ³ï¼ŒAnimatedSize å°±ä¸æœƒæœ‰ 10 çš„è³‡è¨Šï¼Œè€Œæ˜¯é‡æ–°å»ºäº†ä¸€å€‹å¯¬åº¦ç‚º 20 çš„ AnimatedSizeï¼Œè‡ªç„¶ä¹Ÿå°±ä¸æœƒæœ‰å‹•ç•«ã€‚

å¾€å¾Œæœ‰æ©Ÿæœƒçš„è©±ï¼Œæˆ‘å€‘å†ä¾†æ·±å…¥ Animated ç³»åˆ— Widget æ˜¯æ€éº¼è£½ä½œçš„ï¼Œç¾åœ¨å…ˆè®“æˆ‘å€‘çœ‹çœ‹è¦æ€éº¼è§£æ±ºé€™å€‹å•é¡Œå‘¢ï¼Ÿé€™é‚Šæœ‰å…©å€‹æ–¹æ³•ã€‚

## ä½¿ç”¨ Expanded åŒ…ä½è¢«é¸ä¸­çš„ Tab

å¯èƒ½æœ‰è§€çœ¾æœƒå¥½å¥‡ï¼Œç”¨ Expanded åŒ…ä½è¢«é¸ä¸­çš„ Tab çš„è©±ï¼Œé‚£æˆ‘å€‘é‚„æ€éº¼å¯¦ç¾æƒ³è¦çš„æ•ˆæœå‘¢ï¼Ÿç­”æ¡ˆå…¶å¯¦åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ä¹Ÿæœ‰æåˆ°ï¼Œå…¶å¯¦å°±æŠŠ flex è¨­ç‚º 0 å°±å¥½ã€‚åœ¨ flex è¨­ç‚º 0 çš„ç‹€æ…‹ä¸‹ï¼ŒRow å°±æœƒçµ¦è©² Widget ä»»æ„å¤§å°çš„ç©ºé–“ï¼Œè®“ Widget ä½”ä½ä»–éœ€è¦çš„å¤§å°ã€‚

åŒæ™‚ä¹Ÿå› ç‚ºåŒ…äº† Expandedï¼Œæ‰€ä»¥åœ¨ Element æ›´æ–°å­ç¯€é»çš„é‚è¼¯ä¸­ï¼Œå°±èƒ½åœ¨ Widget.canUpdate çš„é‚è¼¯ä¸­è¢«åˆ¤æ–·ç‚ºå¯æ›´æ–°ï¼Œé€²è€Œé¿å…é‡å»ºã€‚

```dart
Row(
  children: [
    for (int index = 0; index < tabLength; index++)
      currentIndex == index
          ? Expanded(
              flex: 0,
              child: AnimatedSize(
                duration: const Duration(milliseconds: 300),
                child: _SelectedTab(index: index),
              ),
            )
          : Expanded(
              child: AnimatedSize(
                duration: const Duration(milliseconds: 300),
                child: GestureDetector(
                  onTap: () => setState(() => currentIndex = index),
                  child: _UnselectedTab(index: index),
                ),
              ),
            )
  ],
)
```

## ä½¿ç”¨ GlobalObjectKey

é™¤äº†ä½¿ç”¨ Expanded + flex ç‚º 0 çš„è¨­å®šä¹‹å¤–ï¼Œæˆ‘å€‘é‚„èƒ½ä½¿ç”¨ GlobalKey ä¾†é¿å… Widget é‡å»ºçš„å•é¡Œã€‚ä½¿ç”¨äº† GlobalKeyï¼Œåœ¨ Element æ›´æ–°å­ç¯€é»æ™‚ï¼Œå°±èƒ½é€é GlobalKey ä¾†è¾¨è­˜ Element æ˜¯å¦å·²ç¶“å»ºç«‹éï¼Œé€²è€Œé‡è¤‡ä½¿ç”¨å…ˆå‰å·²ç¶“å»ºå¥½çš„ Elementã€‚

```dart
Row(
  children: [
    for (int index = 0; index < tabLength; index++)
      currentIndex == index
          ? AnimatedSize(
            key: GlobalObjectKey(index),
            duration: const Duration(milliseconds: 300),
            child: _SelectedTab(index: index),
          )
          : Expanded(
              child: AnimatedSize(
                key: GlobalObjectKey(index),
                duration: const Duration(milliseconds: 300),
                child: GestureDetector(
                  onTap: () => setState(() => currentIndex = index),
                  child: _UnselectedTab(index: index),
                ),
              ),
            )
  ],
)
```

ç•¶ Widget ä½¿ç”¨äº† GlobalKey ä¹‹å¾Œï¼Œé›–ç„¶åœ¨ updateChild æ–¹æ³•ä¸­ä¾èˆŠæœƒèµ°åˆ° inflateWidget å˜—è©¦é‡å»º Elementï¼Œä½†æ˜¯åœ¨ inflateWidget æ–¹æ³•ä¸­ï¼Œå…¶å¯¦é‚„æœ‰ä¸€å ´æ•—éƒ¨å¾©æ´»è³½ã€‚Element æœƒå¾è¢«åœç”¨çš„å­ç¯€é»ä¸­ï¼Œæ‰¾å°‹æ˜¯å¦æœ‰èˆ‡æ–°å­ç¯€é»ä¸€æ¨£çš„ GlobalKey çš„ç¯€é»ï¼Œå¦‚æœæœ‰çš„è©±ï¼Œå°±æŠŠå®ƒæ‹¿å›ä¾†é‡è¤‡åˆ©ç”¨ã€‚

## å°çµ

å¾ä½¿ç”¨ CustomMultiChildLayout è‡ªè£½ Widgetï¼Œå†åˆ°æ¢ç´¢ Row çš„ä½ˆå±€é‚è¼¯ï¼Œè¼¾è½‰ä¹‹å¾Œï¼Œé‚„å¸¶è‘—è§€çœ¾ä¸€èµ·çœ‹äº†éƒ¨åˆ† Element æ›´æ–°æ©Ÿåˆ¶ã€‚é›–ç„¶æˆ‘å€‘å¯èƒ½ä¸å¤ªæœ‰æ©Ÿæœƒä¿®æ”¹åˆ°åº•å±¤æ¡†æ¶çš„æ©Ÿåˆ¶ï¼Œä½†æ˜¯èªè­˜é€™äº›æ©Ÿåˆ¶æœ‰åŠ©æ–¼æˆ‘å€‘åœ¨é–‹ç™¼çš„æ™‚å€™æé«˜ç¨‹å¼é‹è¡Œæ•ˆèƒ½ï¼Œä¹Ÿèƒ½åœ¨ç¢°åˆ°å•é¡Œçš„æ™‚å€™ï¼Œæœ‰æ›´å¤šè³‡è¨Šå¯ä»¥æä¾›è§£æ±ºæ€è·¯ã€‚

## åƒè€ƒé€£çµ

- Element åŸå§‹ç¢¼ï¼šhttps://github.com/flutter/flutter/blob/master/packages/flutter/lib/src/widgets/framework.dart